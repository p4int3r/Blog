# 命令注入攻击

## 查找OS命令注入漏洞

有两种类型的元字符可用在一个现有的预先设定的命令中注入一个独立的命令：

    字符：| &和换行符可用在将几个命令逐个连接在一起。
    反引号（`）：用于将一个独立的命令包含在最初的命令处理的数据中。

通常，检测命令注入是否可行的最可靠的方法是使用时间延迟推断。

**渗透测试步骤：**

(1) 通常可以使用`ping`命令让服务器在一段时间内检测它的回环接口，从而触发时间延迟。例如：

    || ping -i 30 127.0.0.1; x || ping -n 30 127.0.0.1 &

如果应用程序过滤掉某些命令分隔符，为加大检测到命令注入漏洞的可能性，还应该轮流向每一个目标参数提交下面的每个测试字符串，并监控应用程序进行响应的时间。

    | ping -i 30 127.0.0.1 |
    | ping -n 30 127.0.0.1 | 
    & ping -i 30 127.0.0.1 &
    & ping -n 30 127.0.0.1 &
    ; ping 127.0.0.1 ;
    %0a ping 127.0.0.1 ;
    ` ping 127.0.0.1 `

(2) 如果发生时间延迟，说明应用程序可能易于受到命令注入攻击。重复几次测试过程，确定延迟不是由于网络延时或其他异常造成的。

(3) 使用所发现的任何一个可成功实施攻击的注入字符串，尝试注入另一个更有用的命令（如`ls`或`dir`），确定是否能够将命令结果返回到浏览器上。

(4) 如果不能直接获得命令的执行结果，还可以尝试使用TFTP上传工具至服务器，使用telnet或netcat建立一个通向自己计算机的反向shell，并用mail命令通过SMTP发送命令结果。可以将命令结果重定向到Web根目录下的一个文件，然后使用浏览器直接获取结果。例如：

    dir > c:\inetpub\wwwroot\foo.txt

(5) 一旦找到注入命令的方法并且能够获得命令执行结果，就应当确定自己的权限，用`whoami`等命令，或尝试向一个受保护的目录写入一个无害的文件。接下来，可以设法提权，扩大攻击战果。

**渗透测试步骤：**

(1) 如果不能使用前面的技巧注入一个完全独立的命令，可以使用<和>读取或写入任意的文件内容。

(2) 应用程序调用的许多操作系统命令都接受大量控制其行为的命令行参数。通常，用户提交的输入以这种参数的形式传送给命令处理，只需要在相关参数后面插入一个空格，就可以在空格后添加另外一个参数。

> 提示：如果攻击者发现Unix平台过滤空格，可以使用包含空白符的字段分隔符的`$IFS`环境变量代替空格。

## 查找动态执行漏洞

**渗透测试步骤：**

(1) 用户提交的所有数据项都可提交给动态执行函数。其中最常见的数据项是cookie参数名和参数值。

(2) 尝试轮流向目标参数提交下列值：

    ;echo%20111111
    echo%20111111
    response.write%20111111
    ;response.write%20111111

(3) 监控应用程序的响应。如果字符串111111被单独返回（即它前面没有其他命令字符串），就表示应用程序可能易于受到脚本命令注入。

(4)  如果字符串111111并未返回，寻找任何表示输入被动态执行的错误消息；另外，可能需要对语法进行调整，以实现注入任意命令的目的。

(5) 如果攻击的应用程序时PHP，可以使用phpinfo()测试。如果成功执行，则会返回PHP环境的配置信息。

(6) 如果应用程序可能易于受到攻击，与前面描述的查找OS命令注入漏洞时一样，注入一些造成时间延迟的命令确认这一点，例如：

    system('ping%20127.0.0.1') 