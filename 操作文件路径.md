# 操作文件路径

## 路径遍历漏洞

### 确定攻击目标

**渗透测试步骤：**

(1) 分析在应用程序解析过程中收集到的信息，确定以下内容。

- 请求参数中明显包含文件或目录名称的所有情形。例如，`include=main.inc`或`template=/en/sidebar`。

- 需要从服务器文件系统（相对于后端数据库）读取数据的所有应用程序功能。例如，显示办公文件或图像。

(2) 在测试其他漏洞过程中，寻找有益的错误消息或其他反常事件。设法确定用户提交的数据被传送给文件API或操作系统命令参数的所有情况。

如果能从本地访问应用程序，执行以下操作。

(1) 使用适当的工具监控服务器上的所有文件系统活动。例如，可以在Windows平台上使用SysInternals开发的FileMon工具，在Linux平台上使用ltrace/strace工具。

(2) 在每一个被提交的参数（包括全部的cookie、查询字符串字段和POST数据项）中插入一个特殊的字符串（如traversaltest）测试应用程序的每一个页面。一次仅针对一个参数进行测试。

(3) 在文件系统监控工具中设置一个过滤器，确定所包含测试字符串的文件系统事件。

(4) 如果发现测试字符串被用作文件或目录，或者出现在文件或目录名中，那么对每一种情况进行测试，确定是否易于受到路径遍历攻击。

### 探查路径遍历漏洞

**渗透测试步骤：**

(1) 假设所针对的参数被附加到应用程序预先设定的目录之后，那么插入任意一个子目录和一个遍历序列，修改参数的值。例如，如果应用程序提交参数：

    file=foo/file1.txt

那么可以尝试提交以下值：

    file=foo/bar/../file.txt

如果两种情况下应用程序的行为完全相同，就表示它易于受到攻击。应该继续进行测试，尝试通过向上回溯到起始目录来访问不同的文件。

(2) 在上述两种情况下，如果应用程序的行为有所不同，那么应用程序可能阻止、删除或净化遍历序列，以使文件路径失败。需要研究是否通过其他方法避开应用程序的确认过滤。

**渗透测试步骤：**

(1) 如果所攻击的应用程序功能只拥有文件读取访问权限，那么尝试访问相关操作系统上的一个已知任何用户均可读取的文件。提交下面其中一个值作为受控制的文件名参数：

    ../../../../../../../../../etc/passwd
    ../../../../../../../../../windows/win.ini

如果成功，浏览器将显示请求的文件内容。

(2) 如果所攻击的功能拥有文件写入访问权限，那么要最终确定应用程序是否易于受到攻击，可能会更加困难。通常，一种有效的测试是尝试写入两个文件，一个文件可被任何用户写入，另一个文件即使是根用户或管理员也禁止写入。例如，在Windows平台上可以尝试写入下面两个文件：
 
    ../../../../../../../writetest.txt
    ../../../../../../../windows/system32/config/sam

在Unix平台上，禁止根用户写入的文件取决于使用的平台版本，但尝试用一个文件重写一个目录绝不可能取得成功，因此可以进行以下尝试：

    ../../../../../tmp/writetest.txt
    ../../../../../tmp

在上面的每对测试中，如果应用程序在响应两个请求时表现出行为差异，那么应用程序可能易于受到攻击。

(3) 还有另一种方法可通过写入访问确定遍历漏洞，即尝试在Web服务器的Web跟目录中写入一个新文件，然后尝试通过浏览器获得这个文件。但是，如果并不知道Web根目录的位置，或者访问文件的用户并不拥有写入权限，这种方法可能不会成功。

### 避开遍历攻击障碍

**渗透测试步骤：**

(1) 尝试始终通过使用斜线或反斜线的路径遍历序列进行测试。许多输入过滤仅检查其中一种序列，而文件系统却支持全部两种序列。

(2) 尝试使用下面的编码方案，对遍历序列进行简单的URL编码。

    点——%2e
    斜线——%2f
    反斜线——%5c

(3) 尝试使用下面的16位Unicode编码：

    点——%u002e
    斜线——%u2215
    反斜线——%u2216

(4) 尝试使用下面的双倍URL编码：

    点——%252e
    斜线——%252f
    反斜线——%255c

(5) 尝试使用下面的超长UTF-8 Unicode编码：

    点——%c0%2e
    斜线——%c0%af
    反斜线——%c0%5c

(6) 如果应用程序尝试通过删除遍历序列来净化用户的输入，但没有以递归的方式应用这种过滤，可以用一个序列替换另一个序列来避开过滤，如：

    ....//
    ....\/
    ..../\
    ....\\

(7) 一些应用程序检查用户提交的文件是否以一种或一组特殊的文件类型结尾，并拒绝访问其他内容的请求。可以使用以下方式避开检查：

    ../../../../../boot.ini%00.jpg

(8) 一些应用程序将它们自己的文件类型后缀名加在用户提交的文件名后，尝试控制被访问的文件类型。在这种情况下，基于相同的原因，前面的任何一种利用都可能取得成功。

(9) 一些应用程序检查用户提交的文件名的开头部分是否为起始目录的某一个子目录，或者一个特殊的文件名。可以通过以下方法避开检查：

    filestore/../../../../etc/passwd

(10) 如果以上针对输入过滤的攻击都无法成功，可能应用程序实施了几种类型的过滤，因此需要同时使用上面的几种攻击方法。例如，如果请求：
    
    diagram1.jog

能够成功，但请求

    foo/../diagram1.jpg

却导致失败，那么尝试使用所有可能的遍历序列，直到第二个请求获得成功。如果使用这些成功的遍历序列仍然无法访问/etc/passwd，就请求以下文件类型过滤，

    diagram1.jpg%00.jpg

彻底检查应用程序定义的起始目录，设法了解它实施的全部过滤，看是否可以利用上述技巧避开每一种过滤。

(11) 如果可以随意访问应用程序，就可以系统性的攻击每种输入，并最终确定通过哪些文件名可以到达文件系统。

### 利用遍历漏洞

可以利用读取访问路径遍历漏洞从包含有用信息的服务器上获取有益的文件，

    操作系统与应用程序的密码文件。
    服务器与应用程序的配置文件。
    可能含有数据库证书的包含文件。
    应用程序使用的数据库源，如MySQL数据库文件或XML文件。
    服务器可执行页面的源代码，以执行代码审查，搜索漏洞。
    可能包含用户名和会话令牌的应用程序日志文件等。

可以利用一个允许写入访问的路径遍历漏洞在服务器上执行任意命令：

    在用户的启动文件夹中创建脚本。
    当用户下一次连接时，修改in.ftpd等文件执行任意命令。

## 文件包含漏洞

### 远程文件包含漏洞

**渗透测试步骤：**

(1) 向每一个目标参数提交一个连接受控制的Web服务器资源的URL，并确定是否收到运行目标应用程序的服务器提出的任何请求。

(2) 如果第一次测试失败，尝试提交一个包含不存在的IP地址的URL，并确定服务器试图与这个地址建立连接时是否出现超时。

(3) 如果存在远程文件包含攻击，则可以构建一段恶意脚本实施攻击。

### 本地文件包含漏洞

(1) 提交服务器上一个已知可执行资源的名称，确定应用程序的行为是否有任何变化。

(2) 提交服务器上一个已知静态资源的名称，确定它的内容是否被复制到应用程序的响应中。

(3) 如果应用程序易于受到本地文件包含攻击，尝试通过Web服务器访问任何无法直接到达的敏感功能或资源。

(4) 测试能否利用之前讲到的遍历技巧访问到其他目录中的文件。





